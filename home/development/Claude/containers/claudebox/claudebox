#!/bin/bash
set -euo pipefail

DOCKER_IMAGE="claude-code-devcontainer"
CONTAINER_NAME="claude-code-auth-$$-$(date +%s)"

CLAUDEBOX_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONTAINER_DIR="$(dirname "$CLAUDEBOX_DIR")"
PROXY_SCRIPT="$CONTAINER_DIR/proxies/claude-auth-proxy.py"

# Get the current working directory to determine project-specific config
CURRENT_DIR="$(pwd)"
# Convert full path to project name by removing home prefix and replacing / with -
# e.g., /Users/elle/code/project/subdir -> code-project-subdir
PROJECT_NAME="${CURRENT_DIR#$HOME/}" # Remove home directory prefix
PROJECT_NAME="${PROJECT_NAME//\//-}" # Replace all / with -

# Initialize variables
CLAUDE_ARGS=()
MOUNT_CLAUDE_MD=false
TEMP_CREDS=""
PROXY_PID=""
MAX_ATTEMPTS=30
ATTEMPT=0
RUN_BASH=false
VERBOSE=false
ENABLE_FIREWALL=false
SAVE_CONVERSATIONS=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --mount-claude-md)
            MOUNT_CLAUDE_MD=true
            shift
            ;;
        --bash)
            RUN_BASH=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --firewall)
            ENABLE_FIREWALL=true
            shift
            ;;
        --continue | -c | --resume | -r)
            SAVE_CONVERSATIONS=true
            CLAUDE_ARGS+=("$1")
            shift
            ;;
        --help)
            cat << 'EOF'
Run Claude Code in a Docker container with credential isolation.

Real API credentials stay on the host and are injected via proxy.

USAGE:
    Run this script from your project directory:

    cd /path/to/your/project
    claudebox [OPTIONS] [CLAUDE_OPTIONS]

OPTIONS:
    --mount-claude-md Mount your real CLAUDE.md file (default: none)
    --bash            Run bash instead of claude
    --verbose         Enable verbose proxy logging
    --firewall        Enable firewall (blocks most network access)
    --help            Show this help

WORKSPACE:
    The current directory becomes /workspace in the container.
    Claude Code will have access to all files in the current directory.

EXAMPLES:
    cd ~/my-project && claudebox
    cd ~/my-project && claudebox --mount-claude-md -p "hello world"
    cd ~/my-project && claudebox --continue
EOF
            exit 0
            ;;
        *)
            # Pass unknown arguments to Claude
            CLAUDE_ARGS+=("$1")
            shift
            ;;
    esac
done

docker info > /dev/null 2>&1 || {
    echo "Docker not running"
    exit 1
}

# Build images if needed
if ! docker image inspect "$DOCKER_IMAGE" > /dev/null 2>&1; then
    [[ "$VERBOSE" == "true" ]] && echo "üî® Building devcontainer image..."
    docker build -t "$DOCKER_IMAGE" -f "$CONTAINER_DIR/Dockerfile" "$CONTAINER_DIR" || exit 1
fi

# Build SSH agent image if needed
SSH_AGENT_IMAGE="claudebox-ssh-agent"
if ! docker image inspect "$SSH_AGENT_IMAGE" > /dev/null 2>&1; then
    [[ "$VERBOSE" == "true" ]] && echo "üî® Building SSH agent image..."
    docker build -t "$SSH_AGENT_IMAGE" -f "$CONTAINER_DIR/proxies/ssh-agent/Dockerfile" "$CONTAINER_DIR/proxies/ssh-agent" || exit 1
fi

# Find an available port
find_available_port() {
    local port=$1
    local max_port=65535
    for ((i = 0; i <= $((max_port - port)); i++)); do
        if ! nc -z localhost $((port + i)) 2> /dev/null; then
            echo $((port + i))
            return 0
        fi
    done
    echo "‚ùå No available ports found in range $port-$max_port" >&2
    return 1
}

# Check if proxy is already running
PROXY_PID=$(pgrep -f "claude-auth-proxy.py" || true)

if [[ -n "$PROXY_PID" ]]; then
    # Proxy is already running, get its port using lsof
    ACTUAL_PORT=$(lsof -P -n -p "$PROXY_PID" -a -i TCP -s TCP:LISTEN 2> /dev/null \
        | grep -v "^COMMAND" | awk '{print $9}' | cut -d: -f2 | head -1)

    if [[ -n "$ACTUAL_PORT" ]]; then
        echo "‚úì Using existing proxy on port $ACTUAL_PORT"
    else
        echo "‚ùå Found proxy process but couldn't determine port"
        exit 1
    fi
else
    # No proxy running, start a new one
    # Find available port in ephemeral range (58080-65535) to avoid conflicts with registered services
    ACTUAL_PORT=$(find_available_port 58080) || exit 1

    echo "üöÄ Starting authentication proxy on port $ACTUAL_PORT"

    # Start proxy in background on the available port
    # Use installed version from PATH if available, otherwise use local
    PROXY_ARGS="--port $ACTUAL_PORT"
    if [[ "$VERBOSE" == "true" ]]; then
        PROXY_ARGS="$PROXY_ARGS --verbose"
        PROXY_LOG="/tmp/claudebox_proxy.log"
        echo "üìù Proxy logs: $PROXY_LOG"
    else
        PROXY_LOG="/dev/null"
    fi

    if command -v claude-auth-proxy.py &> /dev/null; then
        claude-auth-proxy.py "$PROXY_ARGS" > "$PROXY_LOG" 2>&1 &
    else
        python3 "$PROXY_SCRIPT" "$PROXY_ARGS" > "$PROXY_LOG" 2>&1 &
    fi
    PROXY_PID=$!

    # Health check polling - wait for proxy to be ready
    ATTEMPT=0
    while [[ $ATTEMPT -lt $MAX_ATTEMPTS ]]; do
        if ! ps -p "$PROXY_PID" > /dev/null 2>&1; then
            echo "‚ùå Proxy process died unexpectedly"
            exit 1
        fi

        # Try to connect to the proxy port
        if nc -z localhost "$ACTUAL_PORT" 2> /dev/null; then
            echo "‚úÖ Proxy ready"
            break
        fi

        ATTEMPT=$((ATTEMPT + 1))
        if [[ $ATTEMPT -eq $MAX_ATTEMPTS ]]; then
            echo "‚ùå Proxy failed to start after ${MAX_ATTEMPTS} attempts"
            kill $PROXY_PID 2> /dev/null || true
            exit 1
        fi

        sleep 0.2
    done
fi

# Cleanup on exit
cleanup() {
    local exit_code=$?

    # Save conversations from container before removing it (only if --continue/-c/--resume/-r was used)
    if [[ "$SAVE_CONVERSATIONS" == "true" ]] && docker ps -a --format "{{.Names}}" | grep -q "^${CONTAINER_NAME}$" 2> /dev/null; then
        echo ""
        echo "üíæ Saving conversations from container..."

        # Check if container has any conversations
        if docker exec "$CONTAINER_NAME" test -d /home/node/.claude/projects 2> /dev/null; then
            # Create destination directory with correct host-based project name
            mkdir -p "$HOME/.claude/projects/$PROJECT_NAME"

            # Copy conversation files from container to host using correct project name
            # Extracts files from container's project dirs (e.g., "workspace") into host dir
            for project_dir in $(docker exec "$CONTAINER_NAME" find /home/node/.claude/projects -mindepth 1 -maxdepth 1 -type d 2> /dev/null || true); do
                container_name=$(basename "$project_dir")

                # Copy the contents (files) from container project dir to host project dir
                echo "   üì• Saving conversations from container:$container_name ‚Üí host:$PROJECT_NAME"
                docker cp "$CONTAINER_NAME:$project_dir/." "$HOME/.claude/projects/$PROJECT_NAME/" 2> /dev/null || true
            done
            echo "   ‚úÖ Conversations saved to $HOME/.claude/projects/$PROJECT_NAME"
        fi
    fi

    # Remove container (but NOT the proxy - it's shared!)
    docker rm -f "$CONTAINER_NAME" 2> /dev/null || true

    # Clean up temporary files
    rm -f "$TEMP_CREDS" 2> /dev/null || true

    # Note: SSH agent container left running for reuse
    # To stop it manually: docker rm -f claudebox-ssh-agent

    exit $exit_code
}
trap cleanup INT TERM EXIT

# Create dummy credentials file (real creds never touch disk, only dummies)
TEMP_CREDS=$(mktemp) || {
    echo "Failed to create temporary credentials file" >&2
    exit 1
}

# Try to get credentials and replace with dummy tokens in one operation
if ! get-claude-credentials.sh 2> /dev/null | jq '
        .claudeAiOauth.accessToken = "sk-ant-oat01-dummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDQ-DummyAA" |
        .claudeAiOauth.refreshToken = "sk-ant-ort01-dummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDummyDQ-DummyAA"
    ' > "$TEMP_CREDS" 2> /dev/null; then
    # Failed to get credentials or process them, clean up
    rm -f "$TEMP_CREDS"
    TEMP_CREDS=""
fi

# Extract git config from host
GIT_USER_NAME=$(git config --global --get user.name 2>/dev/null || echo "")
GIT_USER_EMAIL=$(git config --global --get user.email 2>/dev/null || echo "")

# Build docker command
docker_cmd=(
    docker run --rm --name "$CONTAINER_NAME" -it
    --memory="2g"
    --cpus="2"
    -v "$(pwd):/workspace" -w /workspace
    -e "ANTHROPIC_BASE_URL=http://host.docker.internal:$ACTUAL_PORT"
)

# Mount openeddir/planning as read-only if it exists
if [[ -d "$(pwd)/openeddir/planning" ]]; then
    docker_cmd+=(-v "$(pwd)/openeddir/planning:/workspace/openeddir/planning:ro")
fi

# Mount only specific files and directories from .claude (explicit allowlist)
if [[ -d "$HOME/.claude" ]]; then
    # Mount settings.json if it exists
    if [[ -f "$HOME/.claude/settings.json" ]]; then
        docker_cmd+=(-v "$HOME/.claude/settings.json:/tmp/claude-general/settings.json:ro")
    fi

    # Mount agents directory if it exists
    if [[ -d "$HOME/.claude/agents" ]]; then
        docker_cmd+=(-v "$HOME/.claude/agents:/tmp/claude-general/agents:ro")
    fi

    # Mount any markdown files in top level .claude directory
    for mdfile in "$HOME/.claude"/*.md; do
        if [[ -f "$mdfile" ]]; then
            filename=$(basename "$mdfile")
            docker_cmd+=(-v "$mdfile:/tmp/claude-general/$filename:ro")
        fi
    done
fi

# Check if project-specific config exists and mount it
PROJECT_CONFIG_DIR="$HOME/.claude/projects/$PROJECT_NAME"
if [[ -d "$PROJECT_CONFIG_DIR" ]]; then
    echo "üìÅ Found project-specific config: $PROJECT_NAME"
    docker_cmd+=(-v "$PROJECT_CONFIG_DIR:/tmp/claude-project:ro")
else
    echo "üìÅ No project-specific config found for: $PROJECT_NAME"
fi

# Mount dummy credentials separately
[[ -n "$TEMP_CREDS" ]] && docker_cmd+=(-v "$TEMP_CREDS:/tmp/credentials.json:ro")
[[ "$MOUNT_CLAUDE_MD" == true && -f "$HOME/.claude/CLAUDE.md" ]] && docker_cmd+=(-v "$HOME/.claude/CLAUDE.md:/tmp/host-claude-md:ro")

# Set up SSH agent container if RunPod config exists
SSH_AGENT_CONTAINER=""
SSH_AGENT_VOLUME="claudebox-ssh-agent"

if [[ -f "$(pwd)/.runpod_config.json" ]]; then
    echo "üìù Found .runpod_config.json, mounting to container"
    docker_cmd+=(-v "$(pwd)/.runpod_config.json:/workspace/.runpod_config.json:ro")

    # Extract SSH key path from config
    RUNPOD_KEY=$(jq -r '.ssh_key // empty' "$(pwd)/.runpod_config.json" 2> /dev/null)

    if [[ -n "$RUNPOD_KEY" ]]; then
        # Expand ~ to home directory
        RUNPOD_KEY="${RUNPOD_KEY/#\~/$HOME}"

        if [[ -f "$RUNPOD_KEY" ]]; then
            echo "üîë Setting up SSH agent container"

            # Check if agent container exists
            if docker ps -a --format '{{.Names}}' | grep -q "^claudebox-ssh-agent$"; then
                # Container exists, check if it's running
                if docker ps --format '{{.Names}}' | grep -q "^claudebox-ssh-agent$"; then
                    echo "   ‚úì SSH agent container already running"
                else
                    echo "   Starting existing SSH agent container..."
                    docker start claudebox-ssh-agent > /dev/null
                fi
            else
                # Container doesn't exist, create it
                echo "   Creating SSH agent container..."
                docker run -d --name=claudebox-ssh-agent \
                    -v "$SSH_AGENT_VOLUME:/.ssh-agent" \
                    "$SSH_AGENT_IMAGE" > /dev/null
                sleep 1 # Wait for agent and socat to start
            fi
            SSH_AGENT_CONTAINER="claudebox-ssh-agent"

            # Add RunPod key to agent (mount only the specific key file)
            echo "   Adding RunPod key to agent..."
            docker run --rm \
                -v "$SSH_AGENT_VOLUME:/.ssh-agent" \
                -v "$RUNPOD_KEY:/tmp/runpod_key:ro" \
                "$SSH_AGENT_IMAGE" \
                ssh-add /tmp/runpod_key

            echo "   ‚úì SSH agent ready"

            # Mount agent volume and set env
            docker_cmd+=(-v "$SSH_AGENT_VOLUME:/.ssh-agent")
            docker_cmd+=(-e "SSH_AUTH_SOCK=/.ssh-agent/proxy-socket")
        else
            echo "‚ö†Ô∏è  RunPod SSH key not found: $RUNPOD_KEY"
        fi
    fi
else
    echo "üìù No .runpod_config.json found in $(pwd)"
fi

# Mount security-sensitive files as read-only to prevent tampering
# Git hooks - prevent malicious hook injection
if [[ -d "$(pwd)/.git/hooks" ]]; then
    docker_cmd+=(-v "$(pwd)/.git/hooks:/workspace/.git/hooks:ro")
fi

# Git config - prevent tampering with git settings (user, remotes, etc.)
if [[ -f "$(pwd)/.git/config" ]]; then
    docker_cmd+=(-v "$(pwd)/.git/config:/workspace/.git/config:ro")
fi

# SSH directory - prevent key/config tampering
if [[ -d "$(pwd)/.ssh" ]]; then
    docker_cmd+=(-v "$(pwd)/.ssh:/workspace/.ssh:ro")
fi

# Environment files - prevent credential modification
for envfile in "$(pwd)"/.env*; do
    if [[ -f "$envfile" ]]; then
        filename=$(basename "$envfile")
        docker_cmd+=(-v "$envfile:/workspace/$filename:ro")
    fi
done

docker_cmd+=("$DOCKER_IMAGE")

# Pass flags and git config to container
export RUN_BASH
export ENABLE_FIREWALL
export GIT_USER_NAME
export GIT_USER_EMAIL

# Run container with setup script
"${docker_cmd[@]}" bash -c "
    # Create necessary directories
    mkdir -p /tmp/overlay-work /tmp/overlay-upper /home/node/.claude

    # Function to copy configs with proper merging
    merge_configs() {
        # Copy general config first if it exists (EXCLUDING projects directory, which have sensitive info)
        if [[ -d /tmp/claude-general ]]; then
            # Copy everything except the projects directory
            find /tmp/claude-general -mindepth 1 -maxdepth 1 ! -name 'projects' -exec cp -r {} /home/node/.claude/ \; 2>/dev/null || true
        fi

        # Overlay project-specific config if it exists (overwriting general)
        if [[ -d /tmp/claude-project ]]; then
            cp -r /tmp/claude-project/* /home/node/.claude/ 2>/dev/null || true
        fi
    }

    # Always use copy method to ensure projects directory is excluded
    # (fuse-overlayfs would expose the entire lower layer including projects/)
    echo '‚úì Using merged configs (copy method, excluding conversations)'
    merge_configs

    # Copy credentials if provided (overwriting any from the mounted directories)
    [[ -f /tmp/credentials.json ]] && cp /tmp/credentials.json /home/node/.claude/.credentials.json

    # Copy host CLAUDE.md if provided (highest priority)
    [[ -f /tmp/host-claude-md ]] && cp /tmp/host-claude-md /home/node/.claude/CLAUDE.md

    # Create minimal config to skip setup screen
    echo '{\"hasCompletedOnboarding\": true}' > /home/node/.claude.json

    # Ensure correct ownership
    chown -R node:node /home/node/.claude 2>/dev/null || true

    # Configure git with host's user info
    if [[ -n \"\$GIT_USER_NAME\" ]]; then
        git config --global user.name \"\$GIT_USER_NAME\"
    fi
    if [[ -n \"\$GIT_USER_EMAIL\" ]]; then
        git config --global user.email \"\$GIT_USER_EMAIL\"
    fi

    # Initialize firewall if enabled
    if [[ \"$ENABLE_FIREWALL\" == \"true\" ]] && [[ -x /usr/local/bin/init-firewall.sh ]]; then
        echo 'üî• Initializing firewall...'
        sudo /usr/local/bin/init-firewall.sh
    fi

    # Start Claude or bash depending on flag
    if [[ \"$RUN_BASH\" == \"true\" ]]; then
        exec bash \"\$@\"
    else
        claude \"\$@\"
    fi
" -- "${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}"
